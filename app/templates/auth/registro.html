{% extends "navbar.html" %}

{% block title %}Crear Cuenta - Mi Aplicación{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/formulario.css') }}" />
<script src="https://kit.fontawesome.com/a2d04d6c0b.js" crossorigin="anonymous"></script>
<style>
    .input-group {
        position: relative;
        margin-bottom: 25px; /* Aumentar espacio para el mensaje de error */
    }
    .validation-message {
        font-size: 0.8rem;
        position: absolute;
        bottom: -18px;
        left: 0;
    }
    .input-group input.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    .input-group input.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    .text-danger { color: #dc3545; }
    .text-success { color: #28a745; }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <form action="{{ url_for('main.registro') }}" method="POST">
        <h2>Crear Cuenta</h2>
        <p class="text-muted">Por favor, llena los siguientes campos para registrarte en la plataforma.</p>

        <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <label for="username">Nombre de Usuario</label>
            <input type="text" name="username" id="username" required data-field="username" />
            <div class="validation-message"></div>
        </div>

        <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <label for="password">Contraseña</label>
            <input type="password" name="password" id="password" required />
            <i class="fa-solid fa-eye eye-icon" id="toggle-password" onclick="togglePassword('password','toggle-password')"></i>
        </div>

        <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <label for="confirm_password">Confirmar Contraseña</label>
            <input type="password" name="confirm_password" id="confirm_password" required />
            <i class="fa-solid fa-eye eye-icon" id="toggle-confirm-password" onclick="togglePassword('confirm_password','toggle-confirm-password')"></i>
        </div>

        <div class="input-group">
            <i class="fas fa-envelope input-icon"></i>
            <label for="correo">Correo Electrónico</label>
            <input type="email" name="correo" id="correo" placeholder="ejemplo@correo.com" required data-field="correo" />
            <div class="validation-message"></div>
        </div>

        <div class="input-group">
            <i class="fas fa-id-card input-icon"></i>
            <label for="nombre_completo">Nombre Completo</label>
            <input type="text" name="nombre_completo" id="nombre_completo" required data-field="nombre_completo" />
            <div class="validation-message"></div>
        </div>

        <div class="input-group">
            <i class="fas fa-address-card input-icon"></i>
            <label for="identificacion">Documento de Identificación</label>
            <input type="text" name="identificacion" id="identificacion" required data-field="identificacion" />
            <div class="validation-message"></div>
        </div>

        <!-- Campo de Rol oculto, se asume que el registro es solo para estudiantes (id_rol=3) -->
        <input type="hidden" name="id_rol" value="3">

        <div class="form-actions" style="justify-content: space-between;">
            <a href="{{ url_for('main.login') }}" class="link-secondary">¿Ya tienes cuenta? Inicia sesión</a>
            <button type="submit" id="submit-btn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Registrarse</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const submitButton = document.getElementById('submit-btn');
        const fieldsToValidate = ['username', 'correo', 'identificacion'];
        let validationState = {
            username: null,
            correo: null,
            identificacion: null
        };

        // --- Validación de disponibilidad en tiempo real ---
        fieldsToValidate.forEach(fieldId => {
            const input = document.getElementById(fieldId);
            let debounceTimer;

            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    validateField(input);
                }, 500); // Espera 500ms después de que el usuario deja de escribir
            });
        });

        async function validateField(input) {
            const field = input.dataset.field;
            const value = input.value.trim();
            const messageContainer = input.nextElementSibling;

            // Resetear estado si el campo está vacío
            if (value === '') {
                resetInputStyle(input, messageContainer);
                validationState[field] = null;
                checkFormValidity();
                return;
            }

            try {
                const response = await fetch(`{{ url_for('main.check_availability') }}?field=${field}&value=${encodeURIComponent(value)}`);
                const data = await response.json();

                if (data.available) {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    messageContainer.textContent = '¡Disponible!';
                    messageContainer.className = 'validation-message text-success';
                    validationState[field] = true;
                } else {
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                    messageContainer.textContent = `El ${field} '${value}' ya está en uso.`;
                    messageContainer.className = 'validation-message text-danger';
                    validationState[field] = false;
                }
            } catch (error) {
                console.error('Error de validación:', error);
                resetInputStyle(input, messageContainer);
                validationState[field] = null; // No se pudo validar, se asume neutral
            }
            checkFormValidity();
        }

        function resetInputStyle(input, messageContainer) {
            input.classList.remove('is-valid', 'is-invalid');
            messageContainer.textContent = '';
            messageContainer.className = 'validation-message';
        }

        function checkFormValidity() {
            // El formulario es inválido si algún campo está explícitamente marcado como no disponible (false)
            const isInvalid = Object.values(validationState).some(state => state === false);
            submitButton.disabled = isInvalid;
        }

        // --- Validación de tildes y contraseñas ---
        const usernameInput = document.getElementById('username');
        if (usernameInput) {
            usernameInput.addEventListener('input', function(e) {
                const accents = /[áéíóúÁÉÍÓÚ]/g;
                if (accents.test(this.value)) {
                    this.value = this.value.replace(accents, '');
                    // Opcional: mostrar una alerta o mensaje
                    const messageContainer = this.nextElementSibling;
                    messageContainer.textContent = 'El nombre de usuario no puede contener tildes.';
                    messageContainer.className = 'validation-message text-danger';
                    setTimeout(() => {
                        if (messageContainer.textContent === 'El nombre de usuario no puede contener tildes.') {
                           validateField(this); // Re-validar para quitar el mensaje si es necesario
                        }
                    }, 2000);
                }
            });
        }

        form.addEventListener('submit', function(event) {
            if (!validatePassword()) event.preventDefault();
        });
    });

    // Función para mostrar/ocultar contraseña
    function togglePassword(inputId, iconId) {
        const passwordField = document.getElementById(inputId);
        const eyeIcon = document.getElementById(iconId);

        if (passwordField.type === "password") {
            passwordField.type = "text";
            eyeIcon.classList.remove("fa-eye");
            eyeIcon.classList.add("fa-eye-slash");
            eyeIcon.style.color = "#007BFF";
        } else {
            passwordField.type = "password";
            eyeIcon.classList.remove("fa-eye-slash");
            eyeIcon.classList.add("fa-eye");
            eyeIcon.style.color = "#888";
        }
    }

    // Función para validar que las contraseñas coincidan
    function validatePassword() {
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirm_password").value;
        if (password !== confirmPassword) {
            alert("Las contraseñas no coinciden. Por favor, inténtalo de nuevo.");
            return false;
        }
        return true;
    }
</script>
{% endblock %}