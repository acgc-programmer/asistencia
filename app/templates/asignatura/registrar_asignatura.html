{% extends 'navbar.html' %}

{% block title %}Registrar Asignatura{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/formulario.css') }}">
<script src="https://kit.fontawesome.com/a2d04d6c0b.js" crossorigin="anonymous"></script>
<style>
    /* Estilos para el autocompletado de profesores */
    .autocomplete-wrapper { position: relative; }
    #profesores_resultados {
        position: absolute; top: 100%; left: 0; right: 0; background: #fff;
        border: 1px solid #ccc; z-index: 1000; max-height: 200px;
        overflow-y: auto; list-style: none; padding: 0; margin: 0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px;
    }
    #profesores_resultados li { padding: 10px 15px; cursor: pointer; transition: background-color 0.2s ease; }
    #profesores_resultados li:hover { background-color: #f0f0f0; }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <form method="POST" id="form-asignatura">
        <h2>Registrar Asignatura</h2>
        <p class="text-muted">Completa los datos de la asignatura y añade los profesores que la impartirán.</p>

        <div class="input-group">
            <label for="tema">Nombre de la Asignatura</label>
            <input type="text" name="tema" id="tema" value="{{ tema_previo or '' }}" required>
        </div>

        <div class="input-group">
            <label for="id_curso">Curso Asignado</label>
            <select name="id_curso" id="id_curso" required>
                <option value="">Selecciona un curso</option>
                {% for curso in cursos %}
                    <option value="{{ curso[0] }}" {% if curso[0] == id_curso_previo %}selected{% endif %}>
                        {{ curso[1] }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="input-group">
            <label>Profesores</label>
            <div class="profesor-adder">
                <div class="input-group autocomplete-wrapper">
                    <input type="text" id="profesor_buscar" placeholder="Buscar profesor para añadir..." autocomplete="off">
                    <ul id="profesores_resultados"></ul>
                </div>
                <button type="button" id="btn-agregar-profesor" class="btn btn-secondary"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <ul id="lista-profesores" class="lista-profesores">
                <!-- Profesores agregados aparecerán aquí -->
            </ul>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Registrar</button>
            <a href="{{ url_for('main.asignatura') }}" class="btn btn-secondary" style="text-decoration: none;"><i class="fas fa-times"></i> Volver</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const buscarInput = document.getElementById('profesor_buscar');
    const resultadosList = document.getElementById('profesores_resultados');
    const agregarBtn = document.getElementById('btn-agregar-profesor');
    const listaProfesores = document.getElementById('lista-profesores');
    const form = document.getElementById('form-asignatura');

    let profesorSeleccionado = null;
    let timeout = null;

    buscarInput.addEventListener('input', () => {
        const query = buscarInput.value.trim();
        profesorSeleccionado = null;
        if (query.length < 2) {
            resultadosList.innerHTML = '';
            return;
        }
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            fetch(`{{ url_for('main.buscar_profesores') }}?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    resultadosList.innerHTML = '';
                    data.forEach(prof => {
                        const li = document.createElement('li');
                        li.textContent = prof.label;
                        li.addEventListener('click', () => {
                            buscarInput.value = prof.label;
                            profesorSeleccionado = { id: prof.id, nombre: prof.label };
                            resultadosList.innerHTML = '';
                        });
                        resultadosList.appendChild(li);
                    });
                });
        }, 300);
    });

    function agregarProfesor(id, nombre) {
        if (document.querySelector(`input[name="id_profesores"][value="${id}"]`)) {
            alert('Este profesor ya ha sido agregado.');
            return false;
        }

        const li = document.createElement('li');
        li.innerHTML = `
            <span>${nombre}</span>
            <input type="hidden" name="id_profesores" value="${id}">
            <button type="button" class="btn-quitar" title="Quitar profesor">&times;</button>
        `;
        listaProfesores.appendChild(li);

        li.querySelector('.btn-quitar').addEventListener('click', () => {
            li.remove();
        });
        return true;
    }

    agregarBtn.addEventListener('click', () => {
        if (!profesorSeleccionado) {
            alert('Por favor, busca y selecciona un profesor de la lista.');
            return;
        }
        if (agregarProfesor(profesorSeleccionado.id, profesorSeleccionado.nombre)) {
            buscarInput.value = '';
            profesorSeleccionado = null;
        }
    });

    form.addEventListener('submit', (e) => {
        const profesoreAgregados = document.querySelectorAll('input[name="id_profesores"]');
        if (profesoreAgregados.length === 0) {
            e.preventDefault();
            alert('Debes agregar al menos un profesor a la asignatura.');
        }
    });
});
</script>
{% endblock %}